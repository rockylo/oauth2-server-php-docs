<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta http-equiv="Content-Language" content="en-us" />
  <meta http-equiv="imagetoolbar" content="false" />
  <meta name="MSSmartTagsPreventParsing" content="true" />

  <title>Doctrine 2</title>

  <link rel="alternate" type="application/atom+xml" title="API Changes" href="changes.atom" />
  <link href="/oauth2-server-php-docs/css/reset.css" rel="stylesheet" type="text/css" />
  <link href="/oauth2-server-php-docs/css/960.css" rel="stylesheet" type="text/css" />
  <link href="/oauth2-server-php-docs/css/uv_active4d.css" rel="stylesheet" type="text/css" />
  <link href="/oauth2-server-php-docs/shared/css/documentation.css" media="screen" rel="stylesheet" type="text/css">
  <link href="/oauth2-server-php-docs/shared/css/pygments.css" media="screen" rel="stylesheet" type="text/css">
  <link href="/oauth2-server-php-docs/css/coderay.css" rel="stylesheet" type="text/css" />

  <script src="/oauth2-server-php-docs/shared/js/jquery.js" type="text/javascript"></script>
  <script src="/oauth2-server-php-docs/shared/js/documentation.js" type="text/javascript"></script>
</head>
<body class="api">
    <div id="header-wrapper">
      <div id="header">
        <div>
          <a class="logo" href="/oauth2-server-php-docs/">
            <img src="/oauth2-server-php-docs/images/oauth2-banner.png"/>
          </a>
          <ul class="nav">
            <li><a href="https://github.com/bshaffer/oauth2-server-php/blob/develop/CHANGELOG.md">Changes</a></li>
            <!-- <li><a href="/oauth2-server-php-docs/changes.atom">
              <img src="/oauth2-server-php-docs/images/feed-icon-28x28.png" width="16" height="16" alt="GitHub API Changes Feed" />
            </a></li> -->
          </ul>
        </div>
      </div><!-- #header -->
    </div><!-- #header-wrapper -->

    <div id="wrapper">
      <div class="content">
    
<h1 id="doctrine-2">Doctrine 2</h1>

<h2 id="create-client-and-access-token-storage">Create Client and Access Token Storage</h2>

<p>To integrate doctrine into your project, first set up your entities. Let’s start with just the Client, User and Access Token models:</p>

<div class="code-container">
<div class="langspec">Yaml</div>
<div class="CodeRay"><div class="code"><div class="CodeRay"><div class="code"><pre class="highlight"><code class="language-yaml"><span class="error">YourNamespace\Entity\OAuthClient</span>:
  <span class="key">type</span>:             <span class="string"><span class="content">entity</span></span>
  <span class="key">table</span>:            <span class="string"><span class="content">oauth_clients</span></span>
  <span class="key">repositoryClass</span>:  <span class="string"><span class="content">YourNamespace\Repository\OAuthClientRepository</span></span>
  <span class="key">id</span>:
    <span class="key">id</span>:
      <span class="key">type</span>:   <span class="string"><span class="content">integer</span></span>
      <span class="key">generator</span>:
        <span class="key">strategy</span>: <span class="string"><span class="content">AUTO</span></span>
  <span class="key">fields</span>:
    <span class="key">client_identifier</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">string</span></span>
      <span class="key">max_length</span>: <span class="string"><span class="content">50</span></span>
      <span class="key">unique</span>:     <span class="string"><span class="content">true</span></span>
    <span class="key">client_secret</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">string</span></span>
      <span class="key">max_length</span>: <span class="string"><span class="content">20</span></span>
    <span class="key">redirect_uri</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">string</span></span>
      <span class="key">max_length</span>: <span class="string"><span class="content">255</span></span>
      <span class="key">default</span>:    <span class="string"><span class="delimiter">"</span><span class="delimiter">"</span></span>

<span class="error">YourNamespace\Entity\OAuthUser</span>:
  <span class="key">type</span>: <span class="string"><span class="content">entity</span></span>
  <span class="key">table</span>: <span class="string"><span class="content">oauth_users</span></span>
  <span class="key">repositoryClass</span>:  <span class="string"><span class="content">YourNamespace\Repository\OAuthUserRepository</span></span>
  <span class="key">id</span>:
    <span class="key">id</span>:
      <span class="key">type</span>:   <span class="string"><span class="content">integer</span></span>
      <span class="key">generator</span>:
        <span class="key">strategy</span>: <span class="string"><span class="content">AUTO</span></span>
  <span class="key">fields</span>:
    <span class="key">email</span>:
      <span class="key">type</span>:   <span class="string"><span class="content">string</span></span>
      <span class="key">unique</span>: <span class="string"><span class="content">true</span></span>
    <span class="key">password</span>:
      <span class="key">type</span>:   <span class="string"><span class="content">string</span></span>
  <span class="key">indexes</span>:
    <span class="key">email_index</span>:
      <span class="key">columns</span>: <span class="string"><span class="content">[ email ]</span></span>

<span class="error">YourNamespace\Entity\OAuthAccessToken</span>:
  <span class="key">type</span>:             <span class="string"><span class="content">entity</span></span>
  <span class="key">table</span>:            <span class="string"><span class="content">oauth_access_tokens</span></span>
  <span class="key">repositoryClass</span>:  <span class="string"><span class="content">YourNamespace\Repository\OAuthAccessTokenRepository</span></span>
  <span class="key">id</span>:
    <span class="key">id</span>:
      <span class="key">type</span>:   <span class="string"><span class="content">integer</span></span>
      <span class="key">generator</span>:
        <span class="key">strategy</span>: <span class="string"><span class="content">AUTO</span></span>
  <span class="key">fields</span>:
    <span class="key">token</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">string</span></span>
      <span class="key">max_length</span>: <span class="string"><span class="content">40</span></span>
      <span class="key">unique</span>:     <span class="string"><span class="content">true</span></span>
    <span class="key">client_id</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">integer</span></span>
    <span class="key">user_id</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">integer</span></span>
      <span class="key">nullable</span>:   <span class="string"><span class="content">true</span></span>
    <span class="key">expires</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">datetime</span></span>
    <span class="key">scope</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">string</span></span>
      <span class="key">max_length</span>: <span class="string"><span class="content">50</span></span>
      <span class="key">nullable</span>:   <span class="string"><span class="content">true</span></span>
  <span class="key">manyToOne</span>:
    <span class="key">client</span>:
      <span class="key">targetEntity</span>: <span class="string"><span class="content">YourNamespace\Entity\OAuthClient</span></span>
      <span class="key">joinColumn</span>:
        <span class="key">name</span>:                 <span class="string"><span class="content">client_id</span></span>
        <span class="key">referencedColumnName</span>: <span class="string"><span class="content">id</span></span>
    <span class="key">user</span>:
      <span class="key">targetEntity</span>: <span class="string"><span class="content">YourNamespace\Entity\OAuthUser</span></span>
      <span class="key">joinColumn</span>:
        <span class="key">name</span>:                 <span class="string"><span class="content">user_id</span></span>
        <span class="key">referencedColumnName</span>: <span class="string"><span class="content">id</span></span></code></pre></div></div></div></div>
</div>
<p>Once you’ve generated the entities from this schema, you will have an <code>OAuthClient</code> and <code>OAuthClientRepository</code>, <code>OAuthUser</code> and <code>OAuthUserRepository</code>, as well as an <code>OAuthAccessToken</code> and <code>OAuthAccessTokenRepository</code> files.</p>

<p>Just for the reference, here’s are how the entities should look:</p>

<div class="code-container">
<div class="langspec">Php</div>
<div class="CodeRay"><div class="code"><div class="CodeRay"><div class="code"><pre class="highlight"><code class="language-php"><span class="keyword">namespace</span> <span class="constant">YourNamespace</span>\<span class="constant">Entity</span>;

<span class="comment">/**
 * OAuthClient
 * @entity(repositoryClass="YourNamespace\Repository\OAuthClientRepository")
 */</span>
<span class="keyword">class</span> <span class="class">OAuthClient</span> <span class="keyword">extends</span> <span class="constant">EncryptableFieldEntity</span>
{
    <span class="comment">/**
     * @var integer
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$id</span>;

    <span class="comment">/**
     * @var string
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$client_identifier</span>;

    <span class="comment">/**
     * @var string
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$client_secret</span>;

    <span class="comment">/**
     * @var string
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$redirect_uri</span> = <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>;

    <span class="comment">/**
     * Get id
     *
     * @return integer
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getId</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;id;
    }

    <span class="comment">/**
     * Set client_identifier
     *
     * @param string $clientIdentifier
     * @return OAuthClient
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setClientIdentifier</span>(<span class="local-variable">$clientIdentifier</span>)
    {
        <span class="local-variable">$this</span>-&gt;client_identifier = <span class="local-variable">$clientIdentifier</span>;
        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get client_identifier
     *
     * @return string
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getClientIdentifier</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;client_identifier;
    }

    <span class="comment">/**
     * Set client_secret
     *
     * @param string $clientSecret
     * @return OAuthClient
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setClientSecret</span>(<span class="local-variable">$clientSecret</span>)
    {
        <span class="local-variable">$this</span>-&gt;client_secret = <span class="local-variable">$this</span>-&gt;encryptField(<span class="local-variable">$clientSecret</span>);
        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get client_secret
     *
     * @return string
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getClientSecret</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;client_secret;
    }

    <span class="comment">/**
     * Verify client's secret
     *
     * @param string $password
     * @return Boolean
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">verifyClientSecret</span>(<span class="local-variable">$clientSecret</span>)
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;verifyEncryptedFieldValue(<span class="local-variable">$this</span>-&gt;getClientSecret(), <span class="local-variable">$clientSecret</span>);
    }

    <span class="comment">/**
     * Set redirect_uri
     *
     * @param string $redirectUri
     * @return OAuthClient
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setRedirectUri</span>(<span class="local-variable">$redirectUri</span>)
    {
        <span class="local-variable">$this</span>-&gt;redirect_uri = <span class="local-variable">$redirectUri</span>;
        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get redirect_uri
     *
     * @return string
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getRedirectUri</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;redirect_uri;
    }

    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">toArray</span>()
    {
        <span class="keyword">return</span> [
            <span class="string"><span class="delimiter">'</span><span class="content">client_id</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$this</span>-&gt;client_identifier,
            <span class="string"><span class="delimiter">'</span><span class="content">client_secret</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$this</span>-&gt;client_secret,
            <span class="string"><span class="delimiter">'</span><span class="content">redirect_uri</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$this</span>-&gt;redirect_uri,
        ];
    }
}</code></pre></div></div></div></div>
</div>
<div class="code-container">
<div class="langspec">Php</div>
<div class="CodeRay"><div class="code"><div class="CodeRay"><div class="code"><pre class="highlight"><code class="language-php"><span class="keyword">namespace</span> <span class="constant">YourNamespace</span>\<span class="constant">Entity</span>;

<span class="comment">/**
 * OAuthUser
 * @entity(repositoryClass="YourNamespace\Repository\OAuthUserRepository")
 */</span>
<span class="keyword">class</span> <span class="class">OAuthUser</span> <span class="keyword">extends</span> <span class="constant">EncryptableFieldEntity</span>
{
    <span class="comment">/**
     * @var integer
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$id</span>;

    <span class="comment">/**
     * @var string
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$email</span>;

    <span class="comment">/**
     * @var string
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$password</span>;

    <span class="comment">/**
     * Get id
     *
     * @return integer
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getId</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;id;
    }

    <span class="comment">/**
     * Set email
     *
     * @param string $email
     * @return User
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setEmail</span>(<span class="local-variable">$email</span>)
    {
        <span class="local-variable">$this</span>-&gt;email = <span class="local-variable">$email</span>;
        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get email
     *
     * @return string
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getEmail</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;email;
    }

    <span class="comment">/**
     * Set password
     *
     * @param string $password
     * @return User
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setPassword</span>(<span class="local-variable">$password</span>)
    {
        <span class="local-variable">$this</span>-&gt;password = <span class="local-variable">$this</span>-&gt;encryptField(<span class="local-variable">$password</span>);
        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get password
     *
     * @return string
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getPassword</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;password;
    }

    <span class="comment">/**
     * Verify user's password
     *
     * @param string $password
     * @return Boolean
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">verifyPassword</span>(<span class="local-variable">$password</span>)
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;verifyEncryptedFieldValue(<span class="local-variable">$this</span>-&gt;getPassword(), <span class="local-variable">$password</span>);
    }

    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">toArray</span>()
    {
        <span class="keyword">return</span> [
            <span class="string"><span class="delimiter">'</span><span class="content">user_id</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$this</span>-&gt;id,
            <span class="string"><span class="delimiter">'</span><span class="content">scope</span><span class="delimiter">'</span></span> =&gt; <span class="predefined-constant">null</span>,
        ];
    }
}</code></pre></div></div></div></div>
</div>
<div class="code-container">
<div class="langspec">Php</div>
<div class="CodeRay"><div class="code"><div class="CodeRay"><div class="code"><pre class="highlight"><code class="language-php"><span class="keyword">namespace</span> <span class="constant">YourNamespace</span>\<span class="constant">Entity</span>;

<span class="comment">/**
 * OAuthAccessToken
 */</span>
<span class="keyword">class</span> <span class="class">OAuthAccessToken</span>
{
    <span class="comment">/**
     * @var integer
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$id</span>;

    <span class="comment">/**
     * @var string
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$token</span>;

    <span class="comment">/**
     * @var string
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$client_id</span>;

    <span class="comment">/**
     * @var string
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$user_id</span>;

    <span class="comment">/**
     * @var \DateTime
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$expires</span>;

    <span class="comment">/**
     * @var string
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$scope</span>;

    <span class="comment">/**
     * @var \YourNamespace\Entity\OAuthClient
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$client</span>;

    <span class="comment">/**
     * @var \YourNamespace\Entity\OAuthUser
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$user</span>;

    <span class="comment">/**
     * Get id
     *
     * @return integer
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getId</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;id;
    }

    <span class="comment">/**
     * Set token
     *
     * @param string $token
     * @return OAuthAccessToken
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setToken</span>(<span class="local-variable">$token</span>)
    {
        <span class="local-variable">$this</span>-&gt;token = <span class="local-variable">$token</span>;
        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get token
     *
     * @return string
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getToken</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;token;
    }

    <span class="comment">/**
     * Set client_id
     *
     * @param string $clientId
     * @return OAuthAccessToken
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setClientId</span>(<span class="local-variable">$clientId</span>)
    {
        <span class="local-variable">$this</span>-&gt;client_id = <span class="local-variable">$clientId</span>;
        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get client_id
     *
     * @return string
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getClientId</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;client_id;
    }

    <span class="comment">/**
     * Set user_id
     *
     * @param string $userIdentifier
     * @return OAuthAccessToken
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setUserId</span>(<span class="local-variable">$userId</span>)
    {
        <span class="local-variable">$this</span>-&gt;user_id = <span class="local-variable">$userId</span>;
        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get user_identifier
     *
     * @return string
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getUserId</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;user_id;
    }

    <span class="comment">/**
     * Set expires
     *
     * @param \DateTime $expires
     * @return OAuthAccessToken
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setExpires</span>(<span class="local-variable">$expires</span>)
    {
        <span class="local-variable">$this</span>-&gt;expires = <span class="local-variable">$expires</span>;
        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get expires
     *
     * @return \DateTime
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getExpires</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;expires;
    }

    <span class="comment">/**
     * Set scope
     *
     * @param string $scope
     * @return OAuthAccessToken
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setScope</span>(<span class="local-variable">$scope</span>)
    {
        <span class="local-variable">$this</span>-&gt;scope = <span class="local-variable">$scope</span>;
        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get scope
     *
     * @return string
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getScope</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;scope;
    }

    <span class="comment">/**
     * Set client
     *
     * @param \YourNamespace\Entity\OAuthClient $client
     * @return OAuthAccessToken
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setClient</span>(\<span class="constant">YourNamespace</span>\<span class="constant">Entity</span>\<span class="constant">OAuthClient</span> <span class="local-variable">$client</span> = <span class="predefined-constant">null</span>)
    {
        <span class="local-variable">$this</span>-&gt;client = <span class="local-variable">$client</span>;
        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get client
     *
     * @return \YourNamespace\Entity\OAuthClient
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getClient</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;client;
    }

    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">function</span> <span class="function">fromArray</span>(<span class="local-variable">$params</span>)
    {
        <span class="local-variable">$token</span> = <span class="keyword">new</span> <span class="predefined-constant">self</span>();
        <span class="keyword">foreach</span> (<span class="local-variable">$params</span> <span class="keyword">as</span> <span class="local-variable">$property</span> =&gt; <span class="local-variable">$value</span>) {
            <span class="local-variable">$token</span>-&gt;<span class="local-variable">$property</span> = <span class="local-variable">$value</span>;
        }
        <span class="keyword">return</span> <span class="local-variable">$token</span>;
    }

    <span class="comment">/**
     * Set user
     *
     * @param \YourNamespace\Entity\OAuthUser $user
     * @return OAuthRefreshToken
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setUser</span>(\<span class="constant">YourNamespace</span>\<span class="constant">Entity</span>\<span class="constant">OAuthUser</span> <span class="local-variable">$user</span> = <span class="predefined-constant">null</span>)
    {
        <span class="local-variable">$this</span>-&gt;user = <span class="local-variable">$user</span>;
        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get user
     *
     * @return \YourNamespace\Entity\OAuthUser
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getUser</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;client;
    }

    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">toArray</span>()
    {
        <span class="keyword">return</span> [
            <span class="string"><span class="delimiter">'</span><span class="content">token</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$this</span>-&gt;token,
            <span class="string"><span class="delimiter">'</span><span class="content">client_id</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$this</span>-&gt;client_id,
            <span class="string"><span class="delimiter">'</span><span class="content">user_id</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$this</span>-&gt;user_id,
            <span class="string"><span class="delimiter">'</span><span class="content">expires</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$this</span>-&gt;expires,
            <span class="string"><span class="delimiter">'</span><span class="content">scope</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$this</span>-&gt;scope,
        ];
    }
}</code></pre></div></div></div></div>
</div>
<p>I have also created EncryptableEntity class which abstract encryption of sensitive data (client’s secret and user’s password):</p>

<div class="code-container">
<div class="langspec">Php</div>
<div class="CodeRay"><div class="code"><div class="CodeRay"><div class="code"><pre class="highlight"><code class="language-php"><span class="keyword">namespace</span> <span class="constant">YourNamespace</span>\<span class="constant">Entity</span>;

<span class="keyword">class</span> <span class="class">EncryptableFieldEntity</span>
{
    <span class="keyword">protected</span> <span class="local-variable">$hashOptions</span> = [<span class="string"><span class="delimiter">'</span><span class="content">cost</span><span class="delimiter">'</span></span> =&gt; <span class="integer">11</span>];

    <span class="keyword">protected</span> <span class="keyword">function</span> <span class="function">encryptField</span>(<span class="local-variable">$value</span>)
    {
        <span class="keyword">return</span> password_hash(
            <span class="local-variable">$value</span>, <span class="constant">PASSWORD_BCRYPT</span>, <span class="local-variable">$this</span>-&gt;hashOptions);
    }

    <span class="keyword">protected</span> <span class="keyword">function</span> <span class="function">verifyEncryptedFieldValue</span>(<span class="local-variable">$encryptedValue</span>, <span class="local-variable">$value</span>)
    {
        <span class="keyword">return</span> password_verify(<span class="local-variable">$value</span>, <span class="local-variable">$encryptedValue</span>);
    }
}</code></pre></div></div></div></div>
</div>
<p>Implement <code>OAuth2\Storage\ClientCredentialsInterface</code> on the <code>OAuthClientRepository</code> class:</p>

<div class="code-container">
<div class="langspec">Php</div>
<div class="CodeRay"><div class="code"><div class="CodeRay"><div class="code"><pre class="highlight"><code class="language-php"><span class="keyword">namespace</span> <span class="constant">YourNamespace</span>\<span class="constant">Repository</span>;

<span class="keyword">use</span> <span class="constant">Doctrine</span>\<span class="constant">ORM</span>\<span class="constant">EntityRepository</span>;
<span class="keyword">use</span> <span class="constant">OAuth2</span>\<span class="constant">Storage</span>\<span class="constant">ClientCredentialsInterface</span>;

<span class="keyword">class</span> <span class="class">OAuthClientRepository</span> <span class="keyword">extends</span> <span class="constant">EntityRepository</span> <span class="keyword">implements</span> <span class="constant">ClientCredentialsInterface</span>
{
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getClientDetails</span>(<span class="local-variable">$clientIdentifier</span>)
    {
        <span class="local-variable">$client</span> = <span class="local-variable">$client</span> = <span class="local-variable">$this</span>-&gt;findOneBy([<span class="string"><span class="delimiter">'</span><span class="content">client_identifier</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$clientIdentifier</span>]);
        <span class="keyword">if</span> (<span class="local-variable">$client</span>) {
            <span class="local-variable">$client</span> = <span class="local-variable">$client</span>-&gt;toArray();
        }
        <span class="keyword">return</span> <span class="local-variable">$client</span>;
    }

    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">checkClientCredentials</span>(<span class="local-variable">$clientIdentifier</span>, <span class="local-variable">$clientSecret</span> = <span class="predefined-constant">NULL</span>)
    {
        <span class="local-variable">$client</span> = <span class="local-variable">$client</span> = <span class="local-variable">$this</span>-&gt;findOneBy([<span class="string"><span class="delimiter">'</span><span class="content">client_identifier</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$clientIdentifier</span>]);
        <span class="keyword">if</span> (<span class="local-variable">$client</span>) {
            <span class="keyword">return</span> <span class="local-variable">$client</span>-&gt;verifyClientSecret(<span class="local-variable">$clientSecret</span>);
        }
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }

    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">checkRestrictedGrantType</span>(<span class="local-variable">$clientId</span>, <span class="local-variable">$grantType</span>)
    {
        <span class="comment">// we do not support different grant types per client in this example</span>
        <span class="keyword">return</span> <span class="predefined-constant">true</span>;
    }

    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">isPublicClient</span>(<span class="local-variable">$clientId</span>)
    {
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }

    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getClientScope</span>(<span class="local-variable">$clientId</span>)
    {
        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }
}</code></pre></div></div></div></div>
</div>
<p>Now implement <code>OAuth2\Storage\UserCredentialsInterface</code> on the <code>OAuthUser</code> class:</p>

<div class="code-container">
<div class="langspec">Php</div>
<div class="CodeRay"><div class="code"><div class="CodeRay"><div class="code"><pre class="highlight"><code class="language-php"><span class="keyword">namespace</span> <span class="constant">YourNamespace</span>\<span class="constant">Repository</span>;
<span class="keyword">use</span> <span class="constant">Doctrine</span>\<span class="constant">ORM</span>\<span class="constant">EntityRepository</span>;
<span class="keyword">use</span> <span class="constant">OAuth2</span>\<span class="constant">Storage</span>\<span class="constant">UserCredentialsInterface</span>;

<span class="keyword">class</span> <span class="class">OAuthUserRepository</span> <span class="keyword">extends</span> <span class="constant">EntityRepository</span> <span class="keyword">implements</span> <span class="constant">UserCredentialsInterface</span>
{
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">checkUserCredentials</span>(<span class="local-variable">$email</span>, <span class="local-variable">$password</span>)
    {
        <span class="local-variable">$user</span> = <span class="local-variable">$this</span>-&gt;findOneBy([<span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$email</span>]);
        <span class="keyword">if</span> (<span class="local-variable">$user</span>) {
            <span class="keyword">return</span> <span class="local-variable">$user</span>-&gt;verifyPassword(<span class="local-variable">$password</span>);
        }
        <span class="keyword">return</span> <span class="predefined-constant">false</span>;
    }

    <span class="comment">/**
     * @return
     * ARRAY the associated "user_id" and optional "scope" values
     * This function MUST return FALSE if the requested user does not exist or is
     * invalid. "scope" is a space-separated list of restricted scopes.
     * @code
     * return array(
     *     "user_id"  =&gt; USER_ID,    // REQUIRED user_id to be stored with the authorization code or access token
     *     "scope"    =&gt; SCOPE       // OPTIONAL space-separated list of restricted scopes
     * );
     * @endcode
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getUserDetails</span>(<span class="local-variable">$email</span>)
    {
        <span class="local-variable">$user</span> = <span class="local-variable">$this</span>-&gt;findOneBy([<span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$email</span>]);
        <span class="keyword">if</span> (<span class="local-variable">$user</span>) {
            <span class="local-variable">$user</span> = <span class="local-variable">$user</span>-&gt;toArray();
        }
        <span class="keyword">return</span> <span class="local-variable">$user</span>;
    }
}</code></pre></div></div></div></div>
</div>
<p>Now implement <code>OAuth2\Storage\AccessTokenInterface</code> on the <code>OAuthAccessTokenTable</code> class:</p>

<div class="code-container">
<div class="langspec">Php</div>
<div class="CodeRay"><div class="code"><div class="CodeRay"><div class="code"><pre class="highlight"><code class="language-php"><span class="keyword">namespace</span> <span class="constant">YourNamespace</span>\<span class="constant">Repository</span>;

<span class="keyword">use</span> <span class="constant">Doctrine</span>\<span class="constant">ORM</span>\<span class="constant">EntityRepository</span>;
<span class="keyword">use</span> <span class="constant">YourNamespace</span>\<span class="constant">Entity</span>\<span class="constant">OAuthAccessToken</span>;
<span class="keyword">use</span> <span class="constant">OAuth2</span>\<span class="constant">Storage</span>\<span class="constant">AccessTokenInterface</span>;

<span class="keyword">class</span> <span class="class">OAuthAccessTokenRepository</span> <span class="keyword">extends</span> <span class="constant">EntityRepository</span> <span class="keyword">implements</span> <span class="constant">AccessTokenInterface</span>
{
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getAccessToken</span>(<span class="local-variable">$oauthToken</span>)
    {
        <span class="local-variable">$token</span> = <span class="local-variable">$this</span>-&gt;findOneBy([<span class="string"><span class="delimiter">'</span><span class="content">token</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$oauthToken</span>]);
        <span class="keyword">if</span> (<span class="local-variable">$token</span>) {
            <span class="local-variable">$token</span> = <span class="local-variable">$token</span>-&gt;toArray();
            <span class="local-variable">$token</span>[<span class="string"><span class="delimiter">'</span><span class="content">expires</span><span class="delimiter">'</span></span>] = <span class="local-variable">$token</span>[<span class="string"><span class="delimiter">'</span><span class="content">expires</span><span class="delimiter">'</span></span>]-&gt;getTimestamp();
        }
        <span class="keyword">return</span> <span class="local-variable">$token</span>;
    }

    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setAccessToken</span>(<span class="local-variable">$oauthToken</span>, <span class="local-variable">$clientIdentifier</span>, <span class="local-variable">$userEmail</span>, <span class="local-variable">$expires</span>, <span class="local-variable">$scope</span> = <span class="predefined-constant">null</span>)
    {
        <span class="local-variable">$client</span> = <span class="local-variable">$this</span>-&gt;_em-&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">YourNamespace</span><span class="content">\E</span><span class="content">ntity</span><span class="content">\O</span><span class="content">AuthClient</span><span class="delimiter">'</span></span>)
                            -&gt;findOneBy([<span class="string"><span class="delimiter">'</span><span class="content">client_identifier</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$clientIdentifier</span>]);
        <span class="local-variable">$user</span> = <span class="local-variable">$this</span>-&gt;_em-&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">YourNamespace</span><span class="content">\E</span><span class="content">ntity</span><span class="content">\O</span><span class="content">AuthUser</span><span class="delimiter">'</span></span>)
                            -&gt;findOneBy([<span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$userEmail</span>]);
        <span class="local-variable">$token</span> = <span class="constant">OAuthAccessToken</span>::fromArray([
            <span class="string"><span class="delimiter">'</span><span class="content">token</span><span class="delimiter">'</span></span>     =&gt; <span class="local-variable">$oauthToken</span>,
            <span class="string"><span class="delimiter">'</span><span class="content">client</span><span class="delimiter">'</span></span>    =&gt; <span class="local-variable">$client</span>,
            <span class="string"><span class="delimiter">'</span><span class="content">user</span><span class="delimiter">'</span></span>      =&gt; <span class="local-variable">$user</span>,
            <span class="string"><span class="delimiter">'</span><span class="content">expires</span><span class="delimiter">'</span></span>   =&gt; (<span class="keyword">new</span> \<span class="constant">DateTime</span>())-&gt;setTimestamp(<span class="local-variable">$expires</span>),
            <span class="string"><span class="delimiter">'</span><span class="content">scope</span><span class="delimiter">'</span></span>     =&gt; <span class="local-variable">$scope</span>,
        ]);
        <span class="local-variable">$this</span>-&gt;_em-&gt;persist(<span class="local-variable">$token</span>);
        <span class="local-variable">$this</span>-&gt;_em-&gt;<span class="predefined">flush</span>();
    }
}</code></pre></div></div></div></div>
</div>
<p>Good job!  Now, when you create your <code>OAuth\Server</code> object, pass these tables in:</p>

<div class="code-container">
<div class="langspec">Php</div>
<div class="CodeRay"><div class="code"><div class="CodeRay"><div class="code"><pre class="highlight"><code class="language-php"><span class="local-variable">$clientStorage</span>  = <span class="local-variable">$entityManager</span>-&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">YourNamespace</span><span class="content">\E</span><span class="content">ntity</span><span class="content">\O</span><span class="content">AuthClient</span><span class="delimiter">'</span></span>);
<span class="local-variable">$userStorage</span> = <span class="local-variable">$entityManager</span>-&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">YourNamespace</span><span class="content">\E</span><span class="content">ntity</span><span class="content">\O</span><span class="content">AuthUser</span><span class="delimiter">'</span></span>);
<span class="local-variable">$accessTokenStorage</span> = <span class="local-variable">$entityManager</span>-&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">YourNamespace</span><span class="content">\E</span><span class="content">ntity</span><span class="content">\O</span><span class="content">AuthAccessToken</span><span class="delimiter">'</span></span>);

<span class="comment">// Pass the doctrine storage objects to the OAuth2 server class</span>
<span class="local-variable">$server</span> = <span class="keyword">new</span> \<span class="constant">OAuth2</span>\<span class="constant">Server</span>([
    <span class="string"><span class="delimiter">'</span><span class="content">client_credentials</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$clientStorage</span>,
    <span class="string"><span class="delimiter">'</span><span class="content">user_credentials</span><span class="delimiter">'</span></span>   =&gt; <span class="local-variable">$userStorage</span>,
    <span class="string"><span class="delimiter">'</span><span class="content">access_token</span><span class="delimiter">'</span></span>       =&gt; <span class="local-variable">$accessTokenStorage</span>,
], [
    <span class="string"><span class="delimiter">'</span><span class="content">auth_code_lifetime</span><span class="delimiter">'</span></span> =&gt; <span class="integer">30</span>,
    <span class="string"><span class="delimiter">'</span><span class="content">refresh_token_lifetime</span><span class="delimiter">'</span></span> =&gt; <span class="integer">30</span>,
]);</code></pre></div></div></div></div>
</div>
<p>You’ve done it!  You’ve integrated your server with Doctrine!  You can go to town using it, but
since you’ve only passed it a <code>client_credentials</code> and <code>access_token</code> storage object, you can only
use the <code>client_credentials</code> and <code>user_credentials</code> grant types:</p>

<div class="code-container">
<div class="langspec">Php</div>
<div class="CodeRay"><div class="code"><div class="CodeRay"><div class="code"><pre class="highlight"><code class="language-php"><span class="comment">// will be able to handle token requests when "grant_type=client_credentials".</span>
<span class="local-variable">$server</span>-&gt;addGrantType(<span class="keyword">new</span> <span class="constant">OAuth2</span>\<span class="constant">GrantType</span>\<span class="constant">ClientCredentials</span>(<span class="local-variable">$clientStorage</span>));

<span class="comment">// will be able to handle token requests when "grant_type=password".</span>
<span class="local-variable">$server</span>-&gt;addGrantType(<span class="keyword">new</span> \<span class="constant">OAuth2</span>\<span class="constant">GrantType</span>\<span class="constant">UserCredentials</span>(<span class="local-variable">$userStorage</span>));

<span class="comment">// handle the request</span>
<span class="local-variable">$server</span>-&gt;handleTokenRequest(<span class="constant">OAuth2</span>\<span class="constant">Request</span>::createFromGlobals())-&gt;send();</code></pre></div></div></div></div>
</div>
<blockquote>

</blockquote>

<h2 id="add-authorization-code-and-refresh-token-storage">Add Authorization Code and Refresh Token Storage</h2>

<p>So lets make our application a little more exciting.  Add the following to your schema and
generate additional entities:</p>

<div class="code-container">
<div class="langspec">Yaml</div>
<div class="CodeRay"><div class="code"><div class="CodeRay"><div class="code"><pre class="highlight"><code class="language-yaml"><span class="error">YourNamespace\Entity\OAuthAuthorizationCode</span>:
  <span class="key">type</span>:             <span class="string"><span class="content">entity</span></span>
  <span class="key">table</span>:            <span class="string"><span class="content">oauth_authorization_codes</span></span>
  <span class="key">repositoryClass</span>:  <span class="string"><span class="content">YourNamespace\Repository\OAuthAuthorizationCodeRepository</span></span>
  <span class="key">id</span>:
    <span class="key">id</span>:
      <span class="key">type</span>:   <span class="string"><span class="content">integer</span></span>
      <span class="key">generator</span>:
        <span class="key">strategy</span>: <span class="string"><span class="content">AUTO</span></span>
  <span class="key">fields</span>:
    <span class="key">code</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">string</span></span>
      <span class="key">max_length</span>: <span class="string"><span class="content">40</span></span>
      <span class="key">unique</span>:     <span class="string"><span class="content">true</span></span>
    <span class="key">client_id</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">integer</span></span>
    <span class="key">user_id</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">integer</span></span>
      <span class="key">nullable</span>:   <span class="string"><span class="content">true</span></span>
    <span class="key">expires</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">datetime</span></span>
    <span class="key">redirect_uri</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">string</span></span>
      <span class="key">max_length</span>: <span class="string"><span class="content">200</span></span>
    <span class="key">scope</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">string</span></span>
      <span class="key">max_length</span>: <span class="string"><span class="content">50</span></span>
      <span class="key">nullable</span>:   <span class="string"><span class="content">true</span></span>
  <span class="key">manyToOne</span>:
    <span class="key">client</span>:
      <span class="key">targetEntity</span>: <span class="string"><span class="content">YourNamespace\Entity\OAuthClient</span></span>
      <span class="key">joinColumn</span>:
        <span class="key">name</span>:                 <span class="string"><span class="content">client_id</span></span>
        <span class="key">referencedColumnName</span>: <span class="string"><span class="content">id</span></span>
    <span class="key">user</span>:
      <span class="key">targetEntity</span>: <span class="string"><span class="content">YourNamespace\Entity\OAuthUser</span></span>
      <span class="key">joinColumn</span>:
        <span class="key">name</span>:                 <span class="string"><span class="content">user_id</span></span>
        <span class="key">referencedColumnName</span>: <span class="string"><span class="content">id</span></span>

<span class="error">YourNamespace\Entity\OAuthRefreshToken</span>:
  <span class="key">type</span>:             <span class="string"><span class="content">entity</span></span>
  <span class="key">table</span>:            <span class="string"><span class="content">oauth_refresh_tokens</span></span>
  <span class="key">repositoryClass</span>:  <span class="string"><span class="content">YourNamespace\Repository\OAuthRefreshTokenRepository</span></span>
  <span class="key">id</span>:
    <span class="key">id</span>:
      <span class="key">type</span>:   <span class="string"><span class="content">integer</span></span>
      <span class="key">generator</span>:
        <span class="key">strategy</span>: <span class="string"><span class="content">AUTO</span></span>
  <span class="key">fields</span>:
    <span class="key">refresh_token</span>:
      <span class="key">refresh_token</span>:  <span class="string"><span class="content">string</span></span>
      <span class="key">max_length</span>:     <span class="string"><span class="content">40</span></span>
      <span class="key">unique</span>:         <span class="string"><span class="content">true</span></span>
    <span class="key">client_id</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">integer</span></span>
    <span class="key">user_id</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">integer</span></span>
      <span class="key">nullable</span>:   <span class="string"><span class="content">true</span></span>
    <span class="key">expires</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">datetime</span></span>
    <span class="key">scope</span>:
      <span class="key">type</span>:       <span class="string"><span class="content">string</span></span>
      <span class="key">max_length</span>: <span class="string"><span class="content">50</span></span>
      <span class="key">nullable</span>:   <span class="string"><span class="content">true</span></span>
  <span class="key">manyToOne</span>:
    <span class="key">client</span>:
      <span class="key">targetEntity</span>: <span class="string"><span class="content">YourNamespace\Entity\OAuthClient</span></span>
      <span class="key">joinColumn</span>:
        <span class="key">name</span>:                 <span class="string"><span class="content">client_id</span></span>
        <span class="key">referencedColumnName</span>: <span class="string"><span class="content">id</span></span>
    <span class="key">user</span>:
      <span class="key">targetEntity</span>: <span class="string"><span class="content">YourNamespace\Entity\OAuthUser</span></span>
      <span class="key">joinColumn</span>:
        <span class="key">name</span>:                 <span class="string"><span class="content">user_id</span></span>
        <span class="key">referencedColumnName</span>: <span class="string"><span class="content">id</span></span></code></pre></div></div></div></div>
</div>
<p>Just for the reference, here’s how the entities should look:</p>

<div class="code-container">
<div class="langspec">Php</div>
<div class="CodeRay"><div class="code"><div class="CodeRay"><div class="code"><pre class="highlight"><code class="language-php"><span class="keyword">namespace</span> <span class="constant">YourNamespace</span>\<span class="constant">Entity</span>;

<span class="comment">/**
 * OAuthAuthorizationCode
 */</span>
<span class="keyword">class</span> <span class="class">OAuthAuthorizationCode</span>
{
    <span class="comment">/**
     * @var integer
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$id</span>;

    <span class="comment">/**
     * @var string
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$code</span>;

    <span class="comment">/**
     * @var string
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$client_id</span>;

    <span class="comment">/**
     * @var string
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$user_id</span>;

    <span class="comment">/**
     * @var \DateTime
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$expires</span>;

    <span class="comment">/**
     * @var string
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$redirect_uri</span>;

    <span class="comment">/**
     * @var string
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$scope</span>;

    <span class="comment">/**
     * @var \YourNamespace\Entity\OAuthClient
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$client</span>;

    <span class="comment">/**
     * @var \YourNamespace\Entity\OAuthUser
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$user</span>;

    <span class="comment">/**
     * Get id
     *
     * @return integer
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getId</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;id;
    }

    <span class="comment">/**
     * Set code
     *
     * @param string $code
     * @return OAuthAuthorizationCode
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setCode</span>(<span class="local-variable">$code</span>)
    {
        <span class="local-variable">$this</span>-&gt;code = <span class="local-variable">$code</span>;

        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get code
     *
     * @return string
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getCode</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;code;
    }

    <span class="comment">/**
     * Set client_id
     *
     * @param string $clientId
     * @return OAuthAuthorizationCode
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setClientId</span>(<span class="local-variable">$clientId</span>)
    {
        <span class="local-variable">$this</span>-&gt;client_id = <span class="local-variable">$clientId</span>;

        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get client_id
     *
     * @return string
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getClientId</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;client_id;
    }

    <span class="comment">/**
     * Set user_id
     *
     * @param string $userIdentifier
     * @return OAuthAuthorizationCode
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setUserId</span>(<span class="local-variable">$userId</span>)
    {
        <span class="local-variable">$this</span>-&gt;user_id = <span class="local-variable">$userId</span>;

        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get user_identifier
     *
     * @return string
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getUserId</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;user_id;
    }

    <span class="comment">/**
     * Set expires
     *
     * @param \DateTime $expires
     * @return OAuthAuthorizationCode
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setExpires</span>(<span class="local-variable">$expires</span>)
    {
        <span class="local-variable">$this</span>-&gt;expires = <span class="local-variable">$expires</span>;

        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get expires
     *
     * @return \DateTime
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getExpires</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;expires;
    }

    <span class="comment">/**
     * Set redirect_uri
     *
     * @param string $redirectUri
     * @return OAuthAuthorizationCode
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setRedirectUri</span>(<span class="local-variable">$redirectUri</span>)
    {
        <span class="local-variable">$this</span>-&gt;redirect_uri = <span class="local-variable">$redirectUri</span>;

        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get redirect_uri
     *
     * @return string
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getRedirectUri</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;redirect_uri;
    }

    <span class="comment">/**
     * Set scope
     *
     * @param string $scope
     * @return OAuthAuthorizationCode
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setScope</span>(<span class="local-variable">$scope</span>)
    {
        <span class="local-variable">$this</span>-&gt;scope = <span class="local-variable">$scope</span>;

        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get scope
     *
     * @return string
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getScope</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;scope;
    }

    <span class="comment">/**
     * Set client
     *
     * @param \YourNamespace\Entity\OAuthClient $client
     * @return OAuthAuthorizationCode
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setClient</span>(\<span class="constant">YourNamespace</span>\<span class="constant">Entity</span>\<span class="constant">OAuthClient</span> <span class="local-variable">$client</span> = <span class="predefined-constant">null</span>)
    {
        <span class="local-variable">$this</span>-&gt;client = <span class="local-variable">$client</span>;

        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get client
     *
     * @return \YourNamespace\Entity\OAuthClient
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getClient</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;client;
    }

    <span class="comment">/**
     * Set user
     *
     * @param \YourNamespace\Entity\OAuthUser $user
     * @return OAuthRefreshToken
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setUser</span>(\<span class="constant">YourNamespace</span>\<span class="constant">Entity</span>\<span class="constant">OAuthUser</span> <span class="local-variable">$user</span> = <span class="predefined-constant">null</span>)
    {
        <span class="local-variable">$this</span>-&gt;user = <span class="local-variable">$user</span>;

        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get user
     *
     * @return \YourNamespace\Entity\OAuthUser
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getUser</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;client;
    }

    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">toArray</span>()
    {
        <span class="keyword">return</span> [
            <span class="string"><span class="delimiter">'</span><span class="content">code</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$this</span>-&gt;code,
            <span class="string"><span class="delimiter">'</span><span class="content">client_id</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$this</span>-&gt;client_id,
            <span class="string"><span class="delimiter">'</span><span class="content">user_id</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$this</span>-&gt;user_id,
            <span class="string"><span class="delimiter">'</span><span class="content">expires</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$this</span>-&gt;expires,
            <span class="string"><span class="delimiter">'</span><span class="content">scope</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$this</span>-&gt;scope,
        ];
    }

    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">function</span> <span class="function">fromArray</span>(<span class="local-variable">$params</span>)
    {
        <span class="local-variable">$code</span> = <span class="keyword">new</span> <span class="predefined-constant">self</span>();
        <span class="keyword">foreach</span> (<span class="local-variable">$params</span> <span class="keyword">as</span> <span class="local-variable">$property</span> =&gt; <span class="local-variable">$value</span>) {
            <span class="local-variable">$code</span>-&gt;<span class="local-variable">$property</span> = <span class="local-variable">$value</span>;
        }
        <span class="keyword">return</span> <span class="local-variable">$code</span>;
    }
}</code></pre></div></div></div></div>
</div>
<div class="code-container">
<div class="langspec">Php</div>
<div class="CodeRay"><div class="code"><div class="CodeRay"><div class="code"><pre class="highlight"><code class="language-php"><span class="keyword">namespace</span> <span class="constant">YourNamespace</span>\<span class="constant">Entity</span>;

<span class="comment">/**
 * OAuthRefreshToken
 * @entity(repositoryClass="YourNamespace\Repository\OAuthRefreshTokenRepository")
 */</span>
<span class="keyword">class</span> <span class="class">OAuthRefreshToken</span>
{
    <span class="comment">/**
     * @var integer
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$id</span>;

    <span class="comment">/**
     * @var string
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$refresh_token</span>;

    <span class="comment">/**
     * @var string
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$client_id</span>;

    <span class="comment">/**
     * @var string
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$user_id</span>;

    <span class="comment">/**
     * @var \DateTime
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$expires</span>;

    <span class="comment">/**
     * @var string
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$scope</span>;

    <span class="comment">/**
     * @var \YourNamespace\Entity\OAuthClient
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$client</span>;

    <span class="comment">/**
     * @var \YourNamespace\Entity\OAuthUser
     */</span>
    <span class="keyword">private</span> <span class="local-variable">$user</span>;

    <span class="comment">/**
     * Get id
     *
     * @return integer
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getId</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;id;
    }

    <span class="comment">/**
     * Set refresh_token
     *
     * @param string $refresh_token
     * @return OAuthRefreshToken
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setRefreshToken</span>(<span class="local-variable">$refresh_token</span>)
    {
        <span class="local-variable">$this</span>-&gt;refresh_token = <span class="local-variable">$refresh_token</span>;

        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get refresh_token
     *
     * @return string
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getRefreshToken</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;refresh_token;
    }

    <span class="comment">/**
     * Set client_id
     *
     * @param string $clientId
     * @return OAuthRefreshToken
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setClientId</span>(<span class="local-variable">$clientId</span>)
    {
        <span class="local-variable">$this</span>-&gt;client_id = <span class="local-variable">$clientId</span>;

        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get client_id
     *
     * @return string
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getClientId</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;client_id;
    }

    <span class="comment">/**
     * Set user_id
     *
     * @param string $userIdentifier
     * @return OAuthRefreshToken
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setUserId</span>(<span class="local-variable">$userId</span>)
    {
        <span class="local-variable">$this</span>-&gt;user_id = <span class="local-variable">$userId</span>;

        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get user_identifier
     *
     * @return string
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getUserId</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;user_id;
    }

    <span class="comment">/**
     * Set expires
     *
     * @param \DateTime $expires
     * @return OAuthRefreshToken
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setExpires</span>(<span class="local-variable">$expires</span>)
    {
        <span class="local-variable">$this</span>-&gt;expires = <span class="local-variable">$expires</span>;

        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get expires
     *
     * @return \DateTime
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getExpires</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;expires;
    }

    <span class="comment">/**
     * Set scope
     *
     * @param string $scope
     * @return OAuthRefreshToken
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setScope</span>(<span class="local-variable">$scope</span>)
    {
        <span class="local-variable">$this</span>-&gt;scope = <span class="local-variable">$scope</span>;

        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get scope
     *
     * @return string
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getScope</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;scope;
    }

    <span class="comment">/**
     * Set client
     *
     * @param \YourNamespace\Entity\OAuthClient $client
     * @return OAuthRefreshToken
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setClient</span>(\<span class="constant">YourNamespace</span>\<span class="constant">Entity</span>\<span class="constant">OAuthClient</span> <span class="local-variable">$client</span> = <span class="predefined-constant">null</span>)
    {
        <span class="local-variable">$this</span>-&gt;client = <span class="local-variable">$client</span>;

        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get client
     *
     * @return \YourNamespace\Entity\OAuthClient
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getClient</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;client;
    }

    <span class="comment">/**
     * Set user
     *
     * @param \YourNamespace\Entity\OAuthUser $user
     * @return OAuthRefreshToken
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setUser</span>(\<span class="constant">YourNamespace</span>\<span class="constant">Entity</span>\<span class="constant">OAuthUser</span> <span class="local-variable">$user</span> = <span class="predefined-constant">null</span>)
    {
        <span class="local-variable">$this</span>-&gt;user = <span class="local-variable">$user</span>;

        <span class="keyword">return</span> <span class="local-variable">$this</span>;
    }

    <span class="comment">/**
     * Get user
     *
     * @return \YourNamespace\Entity\OAuthUser
     */</span>
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getUser</span>()
    {
        <span class="keyword">return</span> <span class="local-variable">$this</span>-&gt;client;
    }

    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">toArray</span>()
    {
        <span class="keyword">return</span> [
            <span class="string"><span class="delimiter">'</span><span class="content">refresh_token</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$this</span>-&gt;refresh_token,
            <span class="string"><span class="delimiter">'</span><span class="content">client_id</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$this</span>-&gt;client_id,
            <span class="string"><span class="delimiter">'</span><span class="content">user_id</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$this</span>-&gt;user_id,
            <span class="string"><span class="delimiter">'</span><span class="content">expires</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$this</span>-&gt;expires,
            <span class="string"><span class="delimiter">'</span><span class="content">scope</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$this</span>-&gt;scope,
        ];
    }

    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">function</span> <span class="function">fromArray</span>(<span class="local-variable">$params</span>)
    {
        <span class="local-variable">$token</span> = <span class="keyword">new</span> <span class="predefined-constant">self</span>();
        <span class="keyword">foreach</span> (<span class="local-variable">$params</span> <span class="keyword">as</span> <span class="local-variable">$property</span> =&gt; <span class="local-variable">$value</span>) {
            <span class="local-variable">$token</span>-&gt;<span class="local-variable">$property</span> = <span class="local-variable">$value</span>;
        }
        <span class="keyword">return</span> <span class="local-variable">$token</span>;
    }
}</code></pre></div></div></div></div>
</div>
<p>Now we can implement two more interfaces, <code>OAuth2\Storage\AuthorizationCodeInterface</code> and
<code>OAuth2\Storage\RefreshTokenInterface</code>.  This will allow us to use their correspoding grant
types as well.</p>

<p>Implement <code>OAuth2\Storage\AuthorizationCodeInterface</code> on the <code>OAuthAuthorizationCodeRepository</code> class:</p>

<div class="code-container">
<div class="langspec">Php</div>
<div class="CodeRay"><div class="code"><div class="CodeRay"><div class="code"><pre class="highlight"><code class="language-php"><span class="keyword">namespace</span> <span class="constant">YourNamespace</span>\<span class="constant">Repository</span>;

<span class="keyword">use</span> <span class="constant">Doctrine</span>\<span class="constant">ORM</span>\<span class="constant">EntityRepository</span>;
<span class="keyword">use</span> <span class="constant">YourNamespace</span>\<span class="constant">Entity</span>\<span class="constant">OAuthAuthorizationCode</span>;
<span class="keyword">use</span> <span class="constant">OAuth2</span>\<span class="constant">Storage</span>\<span class="constant">AuthorizationCodeInterface</span>;

<span class="keyword">class</span> <span class="class">OAuthAuthorizationCodeRepository</span> <span class="keyword">extends</span> <span class="constant">EntityRepository</span> <span class="keyword">implements</span> <span class="constant">AuthorizationCodeInterface</span>
{
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getAuthorizationCode</span>(<span class="local-variable">$code</span>)
    {
        <span class="local-variable">$authCode</span> = <span class="local-variable">$this</span>-&gt;findOneBy([<span class="string"><span class="delimiter">'</span><span class="content">code</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$code</span>]);
        <span class="keyword">if</span> (<span class="local-variable">$authCode</span>) {
            <span class="local-variable">$authCode</span> = <span class="local-variable">$authCode</span>-&gt;toArray();
            <span class="local-variable">$authCode</span>[<span class="string"><span class="delimiter">'</span><span class="content">expires</span><span class="delimiter">'</span></span>] = <span class="local-variable">$authCode</span>[<span class="string"><span class="delimiter">'</span><span class="content">expires</span><span class="delimiter">'</span></span>]-&gt;getTimestamp();
        }
        <span class="keyword">return</span> <span class="local-variable">$authCode</span>;
    }

    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setAuthorizationCode</span>(<span class="local-variable">$code</span>, <span class="local-variable">$clientIdentifier</span>, <span class="local-variable">$userEmail</span>, <span class="local-variable">$redirectUri</span>, <span class="local-variable">$expires</span>, <span class="local-variable">$scope</span> = <span class="predefined-constant">null</span>)
    {
        <span class="local-variable">$client</span> = <span class="local-variable">$this</span>-&gt;_em-&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">YourNamespace</span><span class="content">\E</span><span class="content">ntity</span><span class="content">\O</span><span class="content">AuthClient</span><span class="delimiter">'</span></span>)
                            -&gt;findOneBy(<span class="predefined">array</span>(<span class="string"><span class="delimiter">'</span><span class="content">client_identifier</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$clientIdentifier</span>));
        <span class="local-variable">$user</span> = <span class="local-variable">$this</span>-&gt;_em-&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">YourNamespace</span><span class="content">\E</span><span class="content">ntity</span><span class="content">\O</span><span class="content">AuthUser</span><span class="delimiter">'</span></span>)
                            -&gt;findOneBy([<span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$userEmail</span>]);
        <span class="local-variable">$authCode</span> = <span class="constant">OAuthAuthorizationCode</span>::fromArray([
           <span class="string"><span class="delimiter">'</span><span class="content">code</span><span class="delimiter">'</span></span>           =&gt; <span class="local-variable">$code</span>,
           <span class="string"><span class="delimiter">'</span><span class="content">client</span><span class="delimiter">'</span></span>         =&gt; <span class="local-variable">$client</span>,
           <span class="string"><span class="delimiter">'</span><span class="content">user</span><span class="delimiter">'</span></span>           =&gt; <span class="local-variable">$user</span>,
           <span class="string"><span class="delimiter">'</span><span class="content">redirect_uri</span><span class="delimiter">'</span></span>   =&gt; <span class="local-variable">$redirectUri</span>,
           <span class="string"><span class="delimiter">'</span><span class="content">expires</span><span class="delimiter">'</span></span>        =&gt; (<span class="keyword">new</span> \<span class="constant">DateTime</span>())-&gt;setTimestamp(<span class="local-variable">$expires</span>),
           <span class="string"><span class="delimiter">'</span><span class="content">scope</span><span class="delimiter">'</span></span>          =&gt; <span class="local-variable">$scope</span>,
        ]);
        <span class="local-variable">$this</span>-&gt;_em-&gt;persist(<span class="local-variable">$authCode</span>);
        <span class="local-variable">$this</span>-&gt;_em-&gt;<span class="predefined">flush</span>();
    }

    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">expireAuthorizationCode</span>(<span class="local-variable">$code</span>)
    {
        <span class="local-variable">$authCode</span> = <span class="local-variable">$this</span>-&gt;findOneBy([<span class="string"><span class="delimiter">'</span><span class="content">code</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$code</span>]);
        <span class="local-variable">$this</span>-&gt;_em-&gt;remove(<span class="local-variable">$authCode</span>);
        <span class="local-variable">$this</span>-&gt;_em-&gt;<span class="predefined">flush</span>();
    }
}</code></pre></div></div></div></div>
</div>
<p>Implement <code>OAuth2\Storage\RefreshTokenInterface</code> on the <code>OAuthRefreshTokenRepository</code> class:</p>

<div class="code-container">
<div class="langspec">Php</div>
<div class="CodeRay"><div class="code"><div class="CodeRay"><div class="code"><pre class="highlight"><code class="language-php"><span class="keyword">namespace</span> <span class="constant">YourNamespace</span>\<span class="constant">Repository</span>;

<span class="keyword">use</span> <span class="constant">Doctrine</span>\<span class="constant">ORM</span>\<span class="constant">EntityRepository</span>;
<span class="keyword">use</span> <span class="constant">YourNamespace</span>\<span class="constant">Entity</span>\<span class="constant">OAuthRefreshToken</span>;
<span class="keyword">use</span> <span class="constant">OAuth2</span>\<span class="constant">Storage</span>\<span class="constant">RefreshTokenInterface</span>;

<span class="keyword">class</span> <span class="class">OAuthRefreshTokenRepository</span> <span class="keyword">extends</span> <span class="constant">EntityRepository</span> <span class="keyword">implements</span> <span class="constant">RefreshTokenInterface</span>
{
    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">getRefreshToken</span>(<span class="local-variable">$refreshToken</span>)
    {
        <span class="local-variable">$refreshToken</span> = <span class="local-variable">$this</span>-&gt;findOneBy([<span class="string"><span class="delimiter">'</span><span class="content">refresh_token</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$refreshToken</span>]);
        <span class="keyword">if</span> (<span class="local-variable">$refreshToken</span>) {
            <span class="local-variable">$refreshToken</span> = <span class="local-variable">$refreshToken</span>-&gt;toArray();
            <span class="local-variable">$refreshToken</span>[<span class="string"><span class="delimiter">'</span><span class="content">expires</span><span class="delimiter">'</span></span>] = <span class="local-variable">$refreshToken</span>[<span class="string"><span class="delimiter">'</span><span class="content">expires</span><span class="delimiter">'</span></span>]-&gt;getTimestamp();
        }
        <span class="keyword">return</span> <span class="local-variable">$refreshToken</span>;
    }

    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">setRefreshToken</span>(<span class="local-variable">$refreshToken</span>, <span class="local-variable">$clientIdentifier</span>, <span class="local-variable">$userEmail</span>, <span class="local-variable">$expires</span>, <span class="local-variable">$scope</span> = <span class="predefined-constant">null</span>)
    {
        <span class="local-variable">$client</span> = <span class="local-variable">$this</span>-&gt;_em-&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">YourNamespace</span><span class="content">\E</span><span class="content">ntity</span><span class="content">\O</span><span class="content">AuthClient</span><span class="delimiter">'</span></span>)
                            -&gt;findOneBy([<span class="string"><span class="delimiter">'</span><span class="content">client_identifier</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$clientIdentifier</span>]);
        <span class="local-variable">$user</span> = <span class="local-variable">$this</span>-&gt;_em-&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">YourNamespace</span><span class="content">\E</span><span class="content">ntity</span><span class="content">\O</span><span class="content">AuthUser</span><span class="delimiter">'</span></span>)
                            -&gt;findOneBy([<span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$userEmail</span>]);
        <span class="local-variable">$refreshToken</span> = <span class="constant">OAuthRefreshToken</span>::fromArray([
           <span class="string"><span class="delimiter">'</span><span class="content">refresh_token</span><span class="delimiter">'</span></span>  =&gt; <span class="local-variable">$refreshToken</span>,
           <span class="string"><span class="delimiter">'</span><span class="content">client</span><span class="delimiter">'</span></span>         =&gt; <span class="local-variable">$client</span>,
           <span class="string"><span class="delimiter">'</span><span class="content">user</span><span class="delimiter">'</span></span>           =&gt; <span class="local-variable">$user</span>,
           <span class="string"><span class="delimiter">'</span><span class="content">expires</span><span class="delimiter">'</span></span>        =&gt; (<span class="keyword">new</span> \<span class="constant">DateTime</span>())-&gt;setTimestamp(<span class="local-variable">$expires</span>),
           <span class="string"><span class="delimiter">'</span><span class="content">scope</span><span class="delimiter">'</span></span>          =&gt; <span class="local-variable">$scope</span>,
        ]);
        <span class="local-variable">$this</span>-&gt;_em-&gt;persist(<span class="local-variable">$refreshToken</span>);
        <span class="local-variable">$this</span>-&gt;_em-&gt;<span class="predefined">flush</span>();
    }

    <span class="keyword">public</span> <span class="keyword">function</span> <span class="function">unsetRefreshToken</span>(<span class="local-variable">$refreshToken</span>)
    {
        <span class="local-variable">$refreshToken</span> = <span class="local-variable">$this</span>-&gt;findOneBy([<span class="string"><span class="delimiter">'</span><span class="content">refresh_token</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$refreshToken</span>]);
        <span class="local-variable">$this</span>-&gt;_em-&gt;remove(<span class="local-variable">$refreshToken</span>);
        <span class="local-variable">$this</span>-&gt;_em-&gt;<span class="predefined">flush</span>();
    }
}</code></pre></div></div></div></div>
</div>
<p>Now we can add two more grant types onto our server:</p>

<div class="code-container">
<div class="langspec">Php</div>
<div class="CodeRay"><div class="code"><div class="CodeRay"><div class="code"><pre class="highlight"><code class="language-php"><span class="local-variable">$clientStorage</span>  = <span class="local-variable">$app</span>[<span class="string"><span class="delimiter">'</span><span class="content">db.orm.em</span><span class="delimiter">'</span></span>]-&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">YourNamespace</span><span class="content">\E</span><span class="content">ntity</span><span class="content">\O</span><span class="content">AuthClient</span><span class="delimiter">'</span></span>);
<span class="local-variable">$userStorage</span> = <span class="local-variable">$app</span>[<span class="string"><span class="delimiter">'</span><span class="content">db.orm.em</span><span class="delimiter">'</span></span>]-&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">YourNamespace</span><span class="content">\E</span><span class="content">ntity</span><span class="content">\O</span><span class="content">AuthUser</span><span class="delimiter">'</span></span>);
<span class="local-variable">$accessTokenStorage</span>  = <span class="local-variable">$app</span>[<span class="string"><span class="delimiter">'</span><span class="content">db.orm.em</span><span class="delimiter">'</span></span>]-&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">YourNamespace</span><span class="content">\E</span><span class="content">ntity</span><span class="content">\O</span><span class="content">AuthAccessToken</span><span class="delimiter">'</span></span>);
<span class="local-variable">$authorizationCodeStorage</span> = <span class="local-variable">$app</span>[<span class="string"><span class="delimiter">'</span><span class="content">db.orm.em</span><span class="delimiter">'</span></span>]-&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">YourNamespace</span><span class="content">\E</span><span class="content">ntity</span><span class="content">\O</span><span class="content">AuthAuthorizationCode</span><span class="delimiter">'</span></span>);
<span class="local-variable">$refreshTokenStorage</span> = <span class="local-variable">$app</span>[<span class="string"><span class="delimiter">'</span><span class="content">db.orm.em</span><span class="delimiter">'</span></span>]-&gt;getRepository(<span class="string"><span class="delimiter">'</span><span class="content">YourNamespace</span><span class="content">\E</span><span class="content">ntity</span><span class="content">\O</span><span class="content">AuthRefreshToken</span><span class="delimiter">'</span></span>);

<span class="comment">// Pass the doctrine storage objects to the OAuth2 server class</span>
<span class="local-variable">$server</span> = <span class="keyword">new</span> \<span class="constant">OAuth2</span>\<span class="constant">Server</span>([
    <span class="string"><span class="delimiter">'</span><span class="content">client_credentials</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$clientStorage</span>,
    <span class="string"><span class="delimiter">'</span><span class="content">user_credentials</span><span class="delimiter">'</span></span>   =&gt; <span class="local-variable">$userStorage</span>,
    <span class="string"><span class="delimiter">'</span><span class="content">access_token</span><span class="delimiter">'</span></span>       =&gt; <span class="local-variable">$accessTokenStorage</span>,
    <span class="string"><span class="delimiter">'</span><span class="content">authorization_code</span><span class="delimiter">'</span></span> =&gt; <span class="local-variable">$authorizationCodeStorage</span>,
    <span class="string"><span class="delimiter">'</span><span class="content">refresh_token</span><span class="delimiter">'</span></span>      =&gt; <span class="local-variable">$refreshTokenStorage</span>,
], [
    <span class="string"><span class="delimiter">'</span><span class="content">auth_code_lifetime</span><span class="delimiter">'</span></span> =&gt; <span class="integer">30</span>,
    <span class="string"><span class="delimiter">'</span><span class="content">refresh_token_lifetime</span><span class="delimiter">'</span></span> =&gt; <span class="integer">30</span>,
]);

<span class="local-variable">$server</span>-&gt;addGrantType(<span class="keyword">new</span> <span class="constant">OAuth2</span>\<span class="constant">GrantType</span>\<span class="constant">ClientCredentials</span>(<span class="local-variable">$clientStorage</span>));
<span class="local-variable">$server</span>-&gt;addGrantType(<span class="keyword">new</span> <span class="constant">OAuth2</span>\<span class="constant">GrantType</span>\<span class="constant">AuthorizationCode</span>(<span class="local-variable">$codeStorage</span>));
<span class="local-variable">$server</span>-&gt;addGrantType(<span class="keyword">new</span> <span class="constant">OAuth2</span>\<span class="constant">GrantType</span>\<span class="constant">RefreshToken</span>(<span class="local-variable">$refreshStorage</span>));

<span class="local-variable">$server</span>-&gt;addGrantType(<span class="keyword">new</span> \<span class="constant">OAuth2</span>\<span class="constant">GrantType</span>\<span class="constant">AuthorizationCode</span>(<span class="local-variable">$authorizationCodeStorage</span>));
<span class="local-variable">$server</span>-&gt;addGrantType(<span class="keyword">new</span> \<span class="constant">OAuth2</span>\<span class="constant">GrantType</span>\<span class="constant">RefreshToken</span>(<span class="local-variable">$refreshTokenStorage</span>, [
    <span class="comment">// the refresh token grant request will have a "refresh_token" field</span>
    <span class="comment">// with a new refresh token on each request</span>
    <span class="string"><span class="delimiter">'</span><span class="content">always_issue_new_refresh_token</span><span class="delimiter">'</span></span> =&gt; <span class="predefined-constant">true</span>,
]));

<span class="comment">// handle the request</span>
<span class="local-variable">$server</span>-&gt;handleTokenRequest(<span class="constant">OAuth2</span>\<span class="constant">Request</span>::createFromGlobals())-&gt;send();</code></pre></div></div></div></div>
</div>
<p>You’ve done it!!!</p>

<p>Few more things to consider:</p>

<ul>
<li>Although I have included the OAuthUser entity and the user credentials grant is working, access tokens are not yet linked with users, you will have to implement this relationship based on your app.</li>
</ul>
      </div>

    <div id="js-sidebar" class="sidebar-shell">
      <div class="js-toggle-list sidebar-module expandable">
        <ul>
          <li class="js-topic">
            <h3><a href="#" class="js-expand-btn collapsed">&nbsp;</a><a href="/oauth2-server-php-docs/">Overview</a></h3>
            <ul class="js-guides">
              <li><a href="/oauth2-server-php-docs/">Get Started</a></li>
              <li><a href="/oauth2-server-php-docs/overview/main-concepts/">Main Concepts</a></li>
              <li><a href="/oauth2-server-php-docs/overview/grant-types/">Grant Types</a></li>
              <li><a href="/oauth2-server-php-docs/overview/controllers/">Controllers</a></li>
              <li><a href="/oauth2-server-php-docs/overview/storage/">Storage</a></li>
              <li><a href="/oauth2-server-php-docs/overview/response/">Request and Response</a></li>
              <li><a href="/oauth2-server-php-docs/overview/scope/">Scope</a></li>
              <li><a href="/oauth2-server-php-docs/overview/userid/">User ID</a></li>
              <li><a href="/oauth2-server-php-docs/overview/jwt-access-tokens/">JWT Access Tokens</a></li>
            </ul>
          </li>
          <li class="js-topic">
            <h3><a href="#" class="js-expand-btn collapsed">&nbsp;</a><a href="/oauth2-server-php-docs/grant-types/authorization-code/">Grant Types</a></h3>
            <ul class="js-guides">
              <li><a href="/oauth2-server-php-docs/grant-types/authorization-code/">Authorization Code</a></li>
              <li><a href="/oauth2-server-php-docs/grant-types/implicit/">Implicit</a></li>
              <li><a href="/oauth2-server-php-docs/grant-types/user-credentials/">User Credentials</a></li>
              <li><a href="/oauth2-server-php-docs/grant-types/client-credentials/">Client Credentials</a></li>
              <li><a href="/oauth2-server-php-docs/grant-types/refresh-token/">Refresh Token</a></li>
              <li><a href="/oauth2-server-php-docs/grant-types/jwt-bearer/">JWT Bearer</a></li>
            </ul>
          </li>
          <li class="js-topic">
            <h3><a href="#" class="js-expand-btn collapsed">&nbsp;</a><a href="/oauth2-server-php-docs/controllers/authorize">Controllers</a></h3>
            <ul class="js-guides">
              <li><a href="/oauth2-server-php-docs/controllers/authorize/">Authorize</a></li>
              <li><a href="/oauth2-server-php-docs/controllers/resource/">Resource</a></li>
              <li><a href="/oauth2-server-php-docs/controllers/token/">Token</a></li>
            </ul>
          </li>
          <li class="js-topic">
            <h3><a href="#" class="js-expand-btn collapsed">&nbsp;</a><a href="/oauth2-server-php-docs/storage/pdo/">Storage</a></h3>
            <ul class="js-guides">
              <li><a href="/oauth2-server-php-docs/storage/pdo/">PDO</a></li>
              <li><a href="/oauth2-server-php-docs/storage/mongo/">Mongo</a></li>
              <li><a href="/oauth2-server-php-docs/storage/redis/">Redis</a></li>
              <li><a href="/oauth2-server-php-docs/storage/cassandra/">Cassandra</a></li>
              <li><a href="/oauth2-server-php-docs/storage/dynamodb/">DynamoDB</a></li>
              <li><a href="/oauth2-server-php-docs/storage/custom/">Custom Storage</a></li>
              <li><a href="/oauth2-server-php-docs/storage/multiple/">Using Multiple Storages</a></li>
            </ul>
          </li>
          <li class="js-topic">
            <h3><a href="#" class="js-expand-btn collapsed">&nbsp;</a><a href="/oauth2-server-php-docs/cookbook/">Cookbook</a></h3>
            <ul class="js-guides">
              <li><a href="/oauth2-server-php-docs/cookbook/">Step-By-Step Walkthrough</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/google-playground/">Google Playground</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/drupal/">Drupal</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/symfony2/">Symfony2</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/silex/">Silex</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/zend-framework/">Zend Framework</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/laravel/">Laravel</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/doctrine/">Doctrine</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/doctrine2/">Doctrine2</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/cakephp/">CakePHP</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/restler/">Restler</a></li>
              <!-- <li><a href="/oauth2-server-php-docs/cookbook/doctrine2/">Doctrine2</a></li>
              <li><a href="/oauth2-server-php-docs/cookbook/symfony/">Symfony 1.4</a></li> -->
            </ul>
          </li>
        </ul>
      </div> <!-- /sidebar-module -->
      <div class="sidebar-module">
        <p>This project is open source. Please help us by forking the project and adding to it.</p>
      </div>
    </div><!-- /sidebar-shell -->

    </div><!-- #wrapper -->

    <div id="footer" >
      <div class="upper_footer">
        <div class="footer_inner clearfix">

        </div><!-- /.site -->
      </div><!-- /.upper_footer -->

      <div class="lower_footer">
        <div class="footer_inner clearfix">
            <div id="legal">
              <p>&copy; <span id="year">year</span> Brent Shaffer. All rights reserved.</p>
            </div><!-- /#legal or /#legal_ie-->
        </div><!-- /.site -->
      </div><!-- /.lower_footer -->
    </div><!-- /#footer -->
    <a href="https://github.com/bshaffer/oauth2-server-php-docs"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"></a>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-11590669-6', 'bshaffer.github.io');
      ga('send', 'pageview');

      function trackOutboundLink(link, category, action) {
        try {
          _gaq.push(['_trackEvent', category , action]);
        } catch(err){}

        setTimeout(function() {
          document.location.href = link.href;
        }, 100);
      }
    </script>
</body>
</html>
